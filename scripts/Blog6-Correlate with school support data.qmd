#after running blog5 qmd
```{r}
#Preview results
enrollment_clean %>%
  filter(LEA_STATE == "MA") %>%
  select(SCH_NAME, Total_Students)
```

```{r}
# Load necessary libraries
library(dplyr)
library(here)
support <- read_csv(here("dataset", "School Support.csv"))
harassment <- read_csv("~/ma4615-sp25-final-project-team-9/dataset/clean_data file/Harassment_and_Bullying_clean.csv")

# STEP 1: Clean the support staff data
support_clean <- support %>%
  mutate(across(c(SCH_FTECOUNSELORS, SCH_FTESERVICES_PSY, SCH_FTESECURITY_GUA),
                ~ ifelse(. < 0, 0, .)))

# STEP 2: Clean the harassment & bullying data
harass_clean <- harassment %>%
  mutate(across(c(
    HBALLEGATIONS_SEX,
    HBALLEGATIONS_REL,
    HBALLEGATIONS_RAC,
    HBALLEGATIONS_DIS,
    HBALLEGATIONS_ORI
  ), ~ ifelse(. < 0, 0, .))) %>%
  rowwise() %>%
  mutate(Total_Allegations = sum(
    c_across(c(
      HBALLEGATIONS_SEX,
      HBALLEGATIONS_REL,
      HBALLEGATIONS_RAC,
      HBALLEGATIONS_DIS,
      HBALLEGATIONS_ORI
    )), na.rm = TRUE
  )) %>%
  ungroup() %>%
  select(COMBOKEY, Total_Allegations)

enrollment_clean <- enrollment_clean %>%
  mutate(COMBOKEY = as.character(COMBOKEY))

harass_clean <- harass_clean %>%
  mutate(COMBOKEY = as.character(COMBOKEY))

# STEP 3: Join all datasets â€” enrollment + support + harassment
combined_ma <- enrollment_clean %>%
  filter(LEA_STATE == "MA") %>%
  select(COMBOKEY, SCH_NAME, Total_Students) %>%
  inner_join(support_clean, by = "COMBOKEY") %>%
  inner_join(harass_clean, by = "COMBOKEY") %>%
  mutate(
    allegations_per_100 = Total_Allegations / Total_Students * 100
  )

# STEP 4: Check correlations
combined_ma %>%
  select(allegations_per_100, SCH_FTECOUNSELORS, SCH_FTESERVICES_PSY, SCH_FTESECURITY_GUA) %>%
  cor(use = "complete.obs")
```

```{r}
# Log-Linear Regression for further check
combined_ma <- combined_ma %>%
  mutate(log_allegations = log(allegations_per_100 + 0.01))

log_model <- lm(log_allegations ~ SCH_FTECOUNSELORS + SCH_FTESERVICES_PSY + SCH_FTESECURITY_GUA,
                data = combined_ma)

summary(log_model)

# Base residual plot
plot(log_model$fitted.values, log_model$residuals,
     xlab = "Fitted Values (log allegations)",
     ylab = "Residuals",
     main = "Residuals vs Fitted Values")
abline(h = 0, col = "red", lty = 2)


qqnorm(log_model$residuals)
qqline(log_model$residuals, col = "lightblue")
```